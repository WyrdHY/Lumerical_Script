
% return n^2-1
% p = [bi, ci]
s1 = @(p,x) (p(1) .* x.^2) ./ (x.^2 - p(2));
s2 = @(p,x) (p(1) .* x.^2) ./ (x.^2 - p(2)) + (p(3) .* x.^2) ./ (x.^2 - p(4));
s3 = @(p,x) (p(1) .* x.^2) ./ (x.^2 - p(2)) + ...
             (p(3) .* x.^2) ./ (x.^2 - p(4)) + ...
             (p(5) .* x.^2) ./ (x.^2 - p(6));


fp = "C:\Users\EricY\Desktop\Lumerical_Simulation\Library\Mat\Sampled Index\Core\Ge-SiO2 (2% doping RTA) (Shijia-UCSB 2024a n 0.459-1.688 µm).txt";

data  = importdata(fp);

x = data(:,1); x = x*1e6; % To um
n = data(:,2); 

% Fit
func = s3;
init_guess = [0.4083,0.01395,0.6965325,0.004368309,0.2083,0.01395];
opts = optimoptions('lsqcurvefit', ...
    'Display','off', ...             % show progress each iteration
    'MaxIterations', 5000, ...        % maximum solver iterations
    'MaxFunctionEvaluations', 2e5, ...% maximum function calls
    'FunctionTolerance', 1e-12, ...   % stop when cost changes < tol
    'StepTolerance', 1e-12);          % stop when parameter changes < tol


target  = n.^2-1;
para = lsqcurvefit(func,init_guess,x,target,[0,0,0,0,0,0],[],opts);


%%
fitted = sqrt(func(para,x)+1);
figure; hold on;
plot(x, n, '--','DisplayName','Raw data');       % data
plot(x, fitted, 'r-','LineWidth',1.5,'DisplayName','Sellmeier fit'); % fit
%xlim([0.2 0.62]);
xlabel('Wavelength (µm)');
ylabel('Refractive index n');
legend('show');
grid on;
